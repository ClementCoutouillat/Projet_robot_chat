#include "system.h"
#include "motorInterface.h"

extern ScanPointCount_t PointDataProcess[MaxScanPointCount];
TaskHandle_t Avoid_Handler;

static uint32_t sysTickCnt = 0;
uint32_t getSysTickCnt(void)
{
    if (xTaskGetSchedulerState() != taskSCHEDULER_NOT_STARTED) /*system is running*/
        return xTaskGetTickCount();
    else
        return sysTickCnt;
}

void Avoid(void *parameter)
{
    uint32_t e;
    uint8_t i;
    uint32_t buf;
    int32_t fsignal = 0;
    int32_t ffsignal = 0;
    int32_t swing;

    while (1)
    {
        /* 接收事件 */
        if (ulTaskNotifyTake(pdTRUE, portMAX_DELAY) > 0)
        {
            for (i = 1; i < 5; i++)
            {
                for (uint16_t x = 0; x < PointDataProcess[i].count; x++)
                {
                    if (PointDataProcess[i].scanPoint[x].distance <= 1200)
                    {
                        if (PointDataProcess[i].scanPoint[x].distance <= 600)
                        {
                            buf = (uint32_t)PointDataProcess[i].scanPoint[x].angle;
                            if ((buf > 325) || (buf < 35))
                            {
                                if (buf > 325)
                                {
                                    fsignal++;
                                }
                                else if (buf < 35)
                                {
                                    fsignal--;
                                }
                            }
                        }
                        else
                        {
                            buf = (uint32_t)PointDataProcess[i].scanPoint[x].angle;
                            if (buf > 180)
                            {
                                ffsignal++;
                            }
                            else if (buf < 180)
                            {
                                ffsignal--;
                            }
                        }
                    }
                }
            }
            if (fsignal != 0)
            {
                if ((fsignal >= -10) && (fsignal <= 10))
                {
                    carStop();
                    swing++;
                }
                else if (fsignal > 10)
                {
                    carRight();
                    swing++;
                }
                else
                {
                    carLeft();
                    swing++;
                }

                if (swing >= 4)
                {
                    swing = 0;
                    ffsignal += fsignal;
                    if (ffsignal > 0)
                    {
                        carRight();
                        // task delay
                        vTaskDelay(100);
                    }
                    else
                    {
                        carLeft();
                        vTaskDelay(100);
                    }
                }
            }
            else
            {
                swing = 0;
                carForward();
            }
            fsignal = 0;
            ffsignal = 0;
            startScan();
        }
        else
        {
            vTaskDelay(100);
        }
    }
}
void createSystemTask(void)
{
    // Task Handle
    xTaskCreate(Avoid, "Avoid", 512, NULL, 1, &Avoid_Handler);
}
// void createSystemTask(void);